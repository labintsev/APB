{% extends "base.html" %}

{% block title %}Регионы{% endblock %}

{% block content %}

<div class="container">
  <div class="card">
    <h2>Средняя цена 1 секунды рекламы для 1000 слушателей [руб / (сек * 1000 чел) ]</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Название региона</th>
          <th>Значение</th>
          <th> </th>
        </tr>
      </thead>
      <tbody>
        {% for r in regions %}
        <tr>
          <td>{{ r.id }}. {{ r.name }}</td>
          <td>
            <input type="number" id="rating-{{ r.id }}" name="rating" value="{{ r.rating }}" min="0" max="100"
              step="0.1">
          </td>
          <td>
            <button type="button" class="save-btn" data-region-id="{{ r.id }}"
              data-current-rating="{{ r.rating }}">Сохранить</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Disable save buttons initially
    document.querySelectorAll('.save-btn').forEach(button => {
      button.style.display = 'none';
      button.disabled = true;
    });

    // Enable save button when rating changes
    document.querySelectorAll('input[name="rating"]').forEach(input => {
      input.addEventListener('change', function () {
        const button = this.closest('tr').querySelector('.save-btn');
        const currentRating = this.value;
        const originalRating = button.dataset.currentRating;

        if (currentRating !== originalRating) {
          button.style.display = 'inline-block';
          button.disabled = false;
        } else {
          button.style.display = 'none';
          button.disabled = true;
        }
      });
    });

    // Handle save button click
    document.querySelectorAll('.save-btn').forEach(button => {
      button.addEventListener('click', function () {
        const regionId = this.dataset.regionId;
        const newRating = document.getElementById('rating-' + regionId).value;

        fetch(`/region/${regionId}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `rating=${encodeURIComponent(newRating)}`
        })
          .then(response => {
            if (response.ok) {
              // Update the current rating for next comparison
              this.dataset.currentRating = newRating;
              this.disabled = true;
              alert('Рейтинг успешно обновлен');
            } else {
              alert('Ошибка при обновлении рейтинга');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при обновлении рейтинга');
          });
      });
    });
  });
</script>

{% endblock %}