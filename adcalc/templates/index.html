{% extends "base.html" %}

{% block title %}Главная{% endblock %}

{% block content %}

<div class="container">
  <div class="card">
    <h1>Калькулятор</h1>
    <form id="budgetForm">
      <div class="form-group">
        <label for="budget">Рекламный бюджет (т.р.):</label>
        <input type="number" id="budget" name="budget" step="0.01" required>
      </div>
      <button type="submit" class="btn btn-primary">Рассчитать</button>
    </form>
    
    <div id="results" class="results" style="display: none;">
      <h2>Распределение бюджета</h2>
      <table class="app-table">
        <thead>
          <tr>
            <th>Организация</th>
            <th>Цена 1 секунды</th>
            <th>Доля бюджета</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.getElementById('budgetForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const budget = parseFloat(document.getElementById('budget').value);
  if (isNaN(budget) || budget <= 0) {
    alert('Пожалуйста, введите корректную сумму бюджета');
    return;
  }
  
  try {
    // Fetch organization data from API
    const response = await fetch('/api/organisations');
    const organisationsData = await response.json();
    
    // Calculate total cost
    const totalCost = Object.values(organisationsData).reduce((sum, cost) => sum + cost, 0);
    
    if (totalCost === 0) {
      document.getElementById('results').style.display = 'none';
      alert('Нет данных для расчета');
      return;
    }
    
    // Calculate shares and populate table
    const resultsBody = document.getElementById('resultsBody');
    resultsBody.innerHTML = '';
    
    for (const [orgName, cost] of Object.entries(organisationsData)) {
      const share = (cost / totalCost) * budget;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${orgName}</td>
        <td>${cost.toFixed(1)} р.</td>
        <td>${share.toFixed(1)} т.р.</td>
      `;
      resultsBody.appendChild(row);
    }
    
    // Show results table
    document.getElementById('results').style.display = 'block';
    
  } catch (error) {
    console.error('Error calculating budget:', error);
    alert('Ошибка при расчете бюджета');
  }
});
</script>

{% endblock %}